<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application - Resume Analyzer & Job Finder</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <nav class="nav">
        <div class="container nav-container">
            <a href="{% url 'index' %}" class="nav-logo">ResumeAI</a>
            <ul class="nav-links">
                <li><a href="{% url 'dashboard' %}" class="nav-link">Dashboard</a></li>
                <li><a href="{% url 'upload_page' %}" class="nav-link">Upload Resume</a></li>
                <li><a href="{% url 'jobs' %}" class="nav-link">Find Jobs</a></li>
                <li><a href="{% url 'profile' %}" class="nav-link">Profile</a></li>
                <li><a href="{% url 'logout' %}" class="btn btn-sm btn-outline">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main style="padding: var(--spacing-xl) 0;">
        <div class="container" style="max-width: 800px;">
            <div style="margin-bottom: var(--spacing-xl);">
                <a href="{% url 'jobs' %}" class="btn btn-outline btn-sm">‚Üê Back to Jobs</a>
            </div>

            <div class="card">
                <h1 style="margin-bottom: var(--spacing-md);">Job Application</h1>

                <div id="job-info"
                    style="padding: var(--spacing-md); background-color: var(--bg-secondary); border-radius: var(--border-radius); margin-bottom: var(--spacing-xl);">
                    <h3 id="job-title" style="margin-bottom: var(--spacing-xs);">Loading...</h3>
                    <p id="job-company" style="color: var(--text-secondary); margin: 0;">Loading...</p>
                </div>

                <form id="application-form">
                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="full-name">Full Name *</label>
                        <input type="text" id="full-name" name="full_name" class="form-input" required>
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="email">Email Address *</label>
                        <input type="email" id="email" name="email" class="form-input" required>
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" class="form-input" required>
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="resume">Upload Resume *</label>
                        <input type="file" id="resume" name="resume" class="form-input" accept=".pdf,.doc,.docx"
                            required>
                        <p
                            style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
                            Accepted formats: PDF, DOC, DOCX (Max 5MB)
                        </p>
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="cover-letter">Cover Letter *</label>
                        <textarea id="cover-letter" name="cover_letter" class="form-input" rows="8" required
                            placeholder="Tell us why you're a great fit for this position..."></textarea>
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="linkedin">LinkedIn Profile (Optional)</label>
                        <input type="url" id="linkedin" name="linkedin" class="form-input"
                            placeholder="https://linkedin.com/in/yourprofile">
                    </div>

                    <div style="margin-bottom: var(--spacing-lg);">
                        <label class="form-label" for="portfolio">Portfolio/Website (Optional)</label>
                        <input type="url" id="portfolio" name="portfolio" class="form-input"
                            placeholder="https://yourportfolio.com">
                    </div>

                    <div style="margin-bottom: var(--spacing-xl);">
                        <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                            <input type="checkbox" id="terms" name="terms" required>
                            <span style="font-size: var(--font-size-sm);">
                                I agree to the terms and conditions and consent to my information being shared with the
                                employer *
                            </span>
                        </label>
                    </div>

                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                        <a href="{% url 'jobs' %}" class="btn btn-outline">Cancel</a>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="{% static 'js/state.js' %}"></script>
    <script src="{% static 'js/utils.js' %}"></script>
    <script>
        // Get job details from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');
        const jobTitle = urlParams.get('title') || 'Job Position';
        const jobCompany = urlParams.get('company') || 'Company';

        // Display job info
        document.getElementById('job-title').textContent = decodeURIComponent(jobTitle);
        document.getElementById('job-company').textContent = decodeURIComponent(jobCompany);

        // Pre-fill user info if available
        const user = StateManager.getUser();
        if (user) {
            if (user.email) document.getElementById('email').value = user.email;
            if (user.name) document.getElementById('full-name').value = user.name;
        }

        // Handle form submission
        document.getElementById('application-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const formData = new FormData(e.target);
            formData.append('job_id', jobId);
            formData.append('job_title', jobTitle);
            formData.append('job_company', jobCompany);

            try {
                const response = await fetch('/core/submit-application/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    Utils.showNotification('Application submitted successfully! The employer will contact you soon.', 'success');

                    // Redirect to jobs page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '{% url "jobs" %}';
                    }, 2000);
                } else {
                    Utils.showNotification(data.error || 'Failed to submit application. Please try again.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Application';
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                Utils.showNotification('An error occurred. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Application';
            }
        });

        // File size validation
        document.getElementById('resume').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.size > 5 * 1024 * 1024) {
                Utils.showNotification('File size must be less than 5MB', 'error');
                e.target.value = '';
            }
        });
    </script>
</body>

</html>